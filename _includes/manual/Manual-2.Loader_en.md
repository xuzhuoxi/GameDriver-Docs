## 2. Loading management module (Loader) - supports free switching of three modes: Resources, Editor, Assetbundle

+ **JLGames.GameDriver.Actions.Loader** provides full support for the loader.
+ **"Tools -> GameDriver -> Project -> Gen LoaderSettings"** provides the generation entry for the loader configuration file.

### 2.1 Initialization

#### 2.1.1 Generate configuration assets
Execute menu "Tools -> GameDriver -> Project -> Gen LoaderSettings".  
The LoaderSettings.asset (renameable) file will be generated under the project Assets/Resources.  
![image](assets/img/loader_1.png)  
![image](assets/img/loader_2.png)  

#### 2.1.2 Set configuration according to project requirements
There are 5 available configurations in LoaderSettings, one Editor mode, two Resource modes, and two AssetBundle modes.  

+ Editor configuration
  ProjectBasePath can set the base path part of the project's resource search, which can be spliced before the resource path when loading resources.
  ![image](assets/img/loader_5.png)
+ Resource configuration
  ProjectBasePath can set the base path part of the project's resource search, which can be spliced before the resource path when loading resources.  
  ![image](assets/img/loader_6.png) ![image](assets/img/loader_7.png)  
+ AssetBundle configuration

  + BundleSource
    You can choose three modes: Web, Streaming Assets, and File Debug.  
    + Web
      Used to load AssetBundle assets stored directly on the site.  
      Fill in the site Url in Web Site Url.  
      Fill in the Parttern path in the Web Site Pattern.  
      ![image](assets/img/loader_3.png)  
    + Streaming Assets
      Used to load AssetBundle resources stored in the project StreamingAssets.  
      Fill in the relative path relative to StreamingAssets in Streaming Parttern.  
      ![image](assets/img/loader_4.png)  
    + File Debug
      Used to load AssetBundle resources in the local file system, mostly used for debugging.  
      Fill in the local file path in File Url.  
      Fill in the relative path related to File Url in File Pattern.  
      ![image](assets/img/loader_9.png)  
  + Base Settings
    It is mainly about the setting of the Bundle directory information of the project and the setting of the cache information when loading.  
    + Project Base Path Set the Bundle directory path of the project
    + CacheName Set the name of the cache area, this can be customized.
    + Version Size Sets the number of versions of each Bundle asset to keep in the cache.
    + History size sets the number of cache areas, each CacheName will generate a cache area.
  + Resource Release Strategy
    There are three options: None, Time, and Counter.  
    + None means that the release strategy is not selected. The invalid memory occupation generated after releasing the Bundle and assets needs to be released by calling gc. This strategy is suitable for self-management of memory and gc timing.
    + Time is a timing release strategy, which will call gc according to the set time period.
      ![image](assets/img/loader_10.png)  
    + Counter is a count release strategy. When the bundle loaded resource reaches the set value and multiple value, gc is called.
      ![image](assets/img/loader_11.png)  

#### 2.1.3 Initializing Loaders with Configuration
Initialize the loader with the following API:  
+ Initialize with the configuration file name generated by [first point]().
````C#
LoaderManager.InitLoader(string loaderName, string settingsName);
````
+ Initialize with a configuration instance.
````C#
LoaderManager.InitLoader(string loaderName, LoaderSettings settings);
````
+ There is a shortcut initialization function in the Loader static class:
````C#
Loader.InitLoader(string settingsName);
````

#### 2.1.4 Initialize Bundle version information
Call the function in the loader instance:  
````C#
InitVersion(LoaderDelegate.OnAssetLoaded<AssetBundleManifest> onVersionAssetBundleLoaded);
````
+ The function callback is executed after the initialization version ends, and the initialization result can be judged internally: success or failure.
+ The function requires to open the coroutine call, you can use LoaderManager.Mono to open the coroutine:
````C#
LoaderManager.Mono.StartCoroutine(LoaderManager.DefaultLoader.InitVersion(onVersionLoaded));
````

### 2.2 Use

#### 2.2.1 Load Bundle assets
Bundle assets can be loaded only after the Bundle version information is initialized.  
The loader implements the IBundleLoader interface and contains functions related to loading Bundle assets.  
Loading Bundle assets requires the use of coroutines, which can be enabled using a LoaderManager.Mono instance to load Bundles by coroutines.  
````C#
LoaderManager.Mono.StartCoroutine(LoaderManager.DefaultLoader.LoadBundleAsync(bundleName, onBundleLoaded, autoRelease, unloadAllLoadedObjects))
````
+ bundleName: bundle asset name.
+ onBundleLoaded: Execute the result callback, which can be used to determine whether it is successful or not.
+ autoRelease: Indicates whether to release the bundle instance after onBundleLoaded execution ends
+ unloadAllLoadedObjects: Indicates whether to release the resource assets instantiated from the bundle instance after onBundleLoaded execution ends
+ If autoRelease is true, all assets to be used should be instantiated in onoBundleLoaded.

#### 2.2.2 Loading resource assets
In the case of obtaining the bundle instance, the instance of the resource asset can be instantiated from the bundle instance, and then cloned and used.  
It is recommended to use synchronous functions for loading resource assets, and asynchronous functions are not recommended. The reason is that Unity does not support opening coroutines within coroutines friendly, and if there are too many layers (like 16 layers), unpredictable errors will appear.  

The IAssetLoader interface functions are divided into four categories:  
+ Single resource asset loading (sync|sync)
```C#
/// <summary>
/// Load asset from bundle synchronously with relative path
/// 使用相对路径从Bundle中加载资源
/// </summary>
/// <param name="assetPath">资源路径</param>
/// <param name="bundle">资源包</param>
/// <typeparam name="T">资源类型</typeparam>
/// <returns></returns>
T LoadAssetSync<T>(string assetPath, AssetBundle bundle) where T : Object;

/// <summary>
/// Load asset from bundle synchronously with full path
/// 使用完整路径从Bundle中加载资源
/// The full path：refers to the relative path after removing ProjectBasePath
/// 完整路径：指的是去除ProjectBasePath后的相对路径
/// </summary>
/// <param name="fullPath">完整资源路径,忽略设置的ProjectBasePath</param>
/// <param name="bundle">资源包</param>
/// <typeparam name="T">资源类型</typeparam>
/// <returns></returns>
T LoadAssetSyncFull<T>(string fullPath, AssetBundle bundle) where T : Object; 

/// <summary>
/// Asynchronously load resources from bundle
/// 异步从资源包中加载资源
/// </summary>
/// <param name="assetPath">资源路径</param>
/// <param name="bundle">资源包</param>
/// <param name="onAssetLoaded">回调</param>
/// <typeparam name="T">资源类型</typeparam>
/// <returns></returns>
IEnumerator LoadAssetAsync<T>(string assetPath, AssetBundle bundle, LoaderDelegate.OnAssetLoaded<T> onAssetLoaded) where T : Object;
```

+ Batch resource asset loading (sync|sync)
```C#
/// <summary>
/// Synchronized load resources from bundle in batches
/// 同步批量从资源包中加载资源
/// </summary>
/// <param name="assetPaths">资源路径</param>
/// <param name="bundle">资源包</param>
/// <typeparam name="T">资源类型</typeparam>
/// <returns></returns>
T[] LoadAssetsSync<T>(string[] assetPaths, AssetBundle bundle) where T : Object;

/// <summary>
/// Synchronized load resources from bundle in batches
/// 同步批量从资源包中加载资源
/// </summary>
/// <param name="fullPaths">完整资源路径,忽略设置的ProjectBasePath</param>
/// <param name="bundle">资源包</param>
/// <typeparam name="T">资源类型</typeparam>
/// <returns></returns>
T[] LoadAssetsSyncFull<T>(string[] fullPaths, AssetBundle bundle) where T : Object;

/// <summary>
/// Batch asynchronously load resources from bundle
/// 异步从资源包中批量加载资源
/// </summary>
/// <param name="assetPaths">路径数组</param>
/// <param name="bundle">资源包</param>
/// <param name="onMultiAssetLoaded">回调</param>
/// <typeparam name="T"></typeparam>
/// <returns></returns>
IEnumerator LoadMulitAssetAsync<T>(string[] assetPaths, AssetBundle bundle, LoaderDelegate.OnMultiAssetLoaded<T> onMultiAssetLoaded)
where T : Object;
```

+ Single sub-resource asset loading (sync|async)
```C#
/// <summary>
/// Load sub-resources (sprites, prefabs, etc.)
/// 加载子资源(子图、预置等)
/// </summary>
/// <param name="path"></param>
/// <param name="subName"></param>
/// <param name="ab"></param>
/// <returns></returns>
Object LoadSubAssetSync(string path, string subName, AssetBundle ab);

/// <summary>
/// Load sub-resources (sprites, prefabs, etc.)
/// 加载子资源(子图、预置等)
/// </summary>
/// <param name="path"></param>
/// <param name="subName"></param>
/// <param name="type"></param>
/// <param name="ab"></param>
/// <returns></returns>
Object LoadSubAssetSync(string path, string subName, Type type, AssetBundle ab);

/// <summary>
/// Load sub-resources (sprites, prefabs, etc.)
/// 加载子资源(子图、预置等)
/// </summary>
/// <param name="path"></param>
/// <param name="subName"></param>
/// <param name="ab"></param>
/// <returns></returns>
T LoadSubAssetSync<T>(string path, string subName, AssetBundle ab) where T : Object;

/// <summary>
/// Load sub-resources (sprites, prefabs, etc.) from bundles asynchronously
/// 异步从资源包中加载加载子资源(子图、预置等)
/// </summary>
/// <param name="assetPath">资源路径</param>
/// <param name="subName"></param>
/// <param name="bundle">资源包</param>
/// <param name="onAssetLoaded">Callback(回调)</param>
/// <typeparam name="T">Resource type(资源类型)</typeparam>
/// <returns></returns>
IEnumerator LoadSubAssetAsync<T>(string assetPath, string subName, AssetBundle bundle, LoaderDelegate.OnAssetLoaded<T> onAssetLoaded)
where T : Object;
```

+ Batch sub-resource asset loading (sync|async)
```C#
/// <summary>
/// Load all sub-resources (sprites, prefabs, etc.)
/// 加载子资源(子图、预置等)
/// </summary>
/// <param name="path"></param>
/// <param name="type"></param>
/// <param name="bundle"></param>
/// <returns></returns>
Object[] LoadSubAssetsSync(string path, Type type, AssetBundle bundle);

/// <summary>
/// Load all sub-resources (sprites, prefabs, etc.)
/// 加载子资源(子图、预置等)
/// </summary>
/// <param name="path"></param>
/// <param name="bundle"></param>
/// <typeparam name="T"></typeparam>
/// <returns></returns>
T[] LoadSubAssetsSync<T>(string path, AssetBundle bundle) where T : Object;

/// <summary>
/// Load sub-resources (sprites, prefabs, etc.)
/// 加载子资源(子图、预置等)
/// </summary>
/// <param name="path"></param>
/// <param name="subNames"></param>
/// <param name="bundle"></param>
/// <returns></returns>
Object[] LoadSubAssetsSync(string path, string[] subNames, AssetBundle bundle);

/// <summary>
/// Load sub-resources (sprites, prefabs, etc.)
/// 加载子资源(子图、预置等)
/// </summary>
/// <param name="path"></param>
/// <param name="subNames"></param>
/// <param name="type"></param>
/// <param name="ab"></param>
/// <returns></returns>
Object[] LoadSubAssetsSync(string path, string[] subNames, Type type, AssetBundle ab);

/// <summary>
/// Load sub-resources (sprites, prefabs, etc.)
/// 加载子资源(子图、预置等)
/// </summary>
/// <param name="path"></param>
/// <param name="subNames"></param>
/// <param name="bundle"></param>
/// <typeparam name="T"></typeparam>
/// <returns></returns>
T[] LoadSubAssetsSync<T>(string path, string[] subNames, AssetBundle bundle) where T : Object;

/// <summary>
/// Load sub-resources (sprites, prefabs, etc.) from bundles asynchronously
/// 异步从资源包中加载加载子资源(子图、预置等)
/// </summary>
/// <param name="assetPath">资源路径</param>
/// <param name="buundle">资源包</param>
/// <param name="onAssetsLoaded">Callback(回调)</param>
/// <typeparam name="T">Resource type(资源类型)</typeparam>
/// <returns></returns>
IEnumerator LoadSubAssetsAsync<T>(string assetPath, AssetBundle buundle, LoaderDelegate.OnMultiAssetLoaded<T> onAssetsLoaded)
where T : Object;
```

+ For more usage, please refer to the example, API or source code.
  
### 2.3 Example
GameDriver/Samples/Loader  
![image](assets/img/loader_8.png)  